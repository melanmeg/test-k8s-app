apiVersion: keda.sh/v1alpha1
kind: ScaledJob
metadata:
  name: example-scaledjob
spec:
  jobTargetRef:
    parallelism: 1
    completions: 1
    backoffLimit: 2
    template:
      spec:
        containers:
          - name: example-job-container
  envSourceContainerName: example-job-container
  pollingInterval: 30
  cooldownPeriod: 30
  minReplicaCount: 0
  maxReplicaCount: 100
  successfulJobsHistoryLimit: 0
  failedJobsHistoryLimit: 0
  advanced:
    horizontalPodAutoscalerConfig:
      resourceMetrics:
        - name: cpu # Name of the metric to scale on
          target:
            type: utilization
            averageUtilization: 1
        - name: memory
          target:
            type: utilization
            averageUtilization: 1
  triggers:
    - type: rabbitmq
      metadata:
        host: amqp://admin:admin@rabbitmq-cluster.rabbitmq:5672/
        protocol: auto
        mode: QueueLength # キュー内のメッセージ数でスケーリング
        value: "1" # キューに1メッセージが追加されるごとに Pod を1つ増加させる
        activationValue: "1" # 初期のアクティベーション値
        queueName: my_queue
        vhostName: /
        unsafeSsl: "true"
