apiVersion: keda.sh/v1alpha1
kind: ScaledJob
metadata:
  name: twicas-monitoring-scaler
spec:
  jobTargetRef:
    parallelism: 1
    completions: 1
    activeDeadlineSeconds: 15000 # 4時間 + 10分
    backoffLimit: 3
    template:
      spec:
        containers:
          - name: twicas-monitoring-container
  envSourceContainerName: twicas-monitoring-container
  pollingInterval: 10
  successfulJobsHistoryLimit: 30
  failedJobsHistoryLimit: 30
  minReplicaCount: 0
  maxReplicaCount: 100
  rolloutStrategy: gradual
  rollout:
    strategy: gradual
    propagationPolicy: foreground
  scalingStrategy:
    strategy: "default"
    multipleScalersCalculation: "max"
  triggers:
    - type: rabbitmq
      metadata:
        host: amqp://admin:admin@rabbitmq-cluster.rabbitmq:5672/
        protocol: auto
        mode: QueueLength # キュー内のメッセージ数でスケーリング
        value: "1" # キューに1メッセージが追加されるごとに Pod を1つ増加させる
        activationValue: "1" # 初期のアクティベーション値
        queueName: my_queue
        vhostName: /
        unsafeSsl: "true"
